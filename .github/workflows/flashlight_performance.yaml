name: Flashlight Performance Testing

on:
  workflow_run:
    workflows: ["Flutter Analyze, Test & Build"]
    types:
      - completed
    branches:
      - "*"

jobs:
  flashlight-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ðŸ“š Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: apk-build
          path: apk
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ðŸ“‹ List Downloaded Files
        run: ls -la apk/

      - name: ðŸ”§ Install Flashlight CLI
        run: |
          curl https://get.flashlight.dev/ | bash
          export PATH="$HOME/.flashlight/bin:$PATH"

      - name: ðŸš€ Upload to Flashlight
        env:
          FLASHLIGHT_API_KEY: ${{ secrets.FLASHLIGHT_API_KEY }}
        run: |
          flashlight cloud --app apk/app-release.apk --test .maestro/launch_app.yaml --apiKey $FLASHLIGHT_API_KEY 
